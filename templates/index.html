<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProcessHub</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
        }
        header {
            background-color: #1F4E78;
            color: white;
            padding: 20px 0;
            text-align: center;
        }
        header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        main {
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
        label {
            font-weight: bold;
        }
        select, input[type="file"], input[type="text"], button {
            margin-top: 10px;
            padding: 10px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 100%;
        }
        button {
            background-color: #1F4E78;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .task-inputs {
            display: none;
        }
        footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9em;
            color: #777;
        }
        .flash-message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            color: #fff;
        }
        .flash-success {
            background-color: #28a745;
        }
        .flash-error {
            background-color: #dc3545;
        }
        .button-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 20px;
        }
        .file-instructions {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
        }
        .task-section {
            margin-bottom: 30px; /* Adds space below the "Select Task" dropdown */
        }
        /* Processing Overlay */
#processing-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
}

.overlay-content {
    text-align: center;
}

.adventure-container {
    width: 80%;
    max-width: 600px;
    margin: 20px auto;
    position: relative;
}

.progress-bar {
    background: #444;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    margin-top: 50px;
}

.progress-fill {
    background: #28a745;
    height: 100%;
    width: 0;
    transition: width 0.5s ease;
}

.character {
    position: absolute;
    top: -40px;
    left: 0;
    width: 40px;
    height: 40px;
    background: url('https://via.placeholder.com/40') no-repeat center;
    background-size: cover;
    transition: left 0.5s ease;
}

.processing-quote {
    font-size: 1.5em;
    margin-top: 20px;
    font-style: italic;
}

#stopwatch-container {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #1F4E78; /* Dark Blue */
    color: #FFFF00; /* Yellow */
    font-weight: bold;
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 1.2em;
    display: none; /* Initially hidden */
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

    </style>
    <script>
        function toggleInputs() {
            const task = document.getElementById("task").value;
            const form = document.getElementById("task-form");

            // Hide all task-specific input sections by default and disable their inputs
            document.querySelectorAll(".task-inputs").forEach(section => {
                section.style.display = "none";
                section.querySelectorAll("input").forEach(input => {
                    input.disabled = true;
                });
            });

            // Update form action and show inputs based on the selected task
            if (task === "bulk_report") {
                form.action = "/";
                const bulkInputs = document.getElementById("bulk-report-inputs");
                bulkInputs.style.display = "block";
                bulkInputs.querySelectorAll("input").forEach(input => {
                    input.disabled = false;
                });
            } else if (task === "replen_stock") {
                form.action = "/run-replen";
                const replenInputs = document.getElementById("replen-stock-inputs");
                replenInputs.style.display = "block";
                replenInputs.querySelectorAll("input").forEach(input => {
                    input.disabled = false;
                });
            } else if (task === "check_empty_location") {
                form.action = "/run-checkempty";
                const checkEmptyInputs = document.getElementById("check-empty-location-inputs");
                checkEmptyInputs.style.display = "block";
                checkEmptyInputs.querySelectorAll("input").forEach(input => {
                    input.disabled = false;
                });
           } else if (task === "target_performance") {
               form.action = "/run-target-performance"; // Backend route for Target Performance
               const targetInputs = document.getElementById("target-performance-inputs");
               targetInputs.style.display = "block";
               targetInputs.querySelectorAll("input").forEach(input => {
                    input.disabled = false;
                });
           } else if (task === "replen_backorder_greece") {
               form.action = "/run-replen-backorder-greece";  // New backend route
               const replenBackorderInputs = document.getElementById("replen-backorder-greece-inputs");
               replenBackorderInputs.style.display = "block";
               replenBackorderInputs.querySelectorAll("input").forEach(input => {
                    input.disabled = false;
                });

            } else {
                form.action = "#";
            }
        }

// Validate if a file is selected before form submission
function validateForm() {
    const task = document.getElementById("task").value;

    // Get all file input fields that are currently enabled
    let fileInputs = document.querySelectorAll(".task-inputs:not([style*='display: none']) input[type='file']");

    let hasFile = false;
    fileInputs.forEach(input => {
        if (input.files.length > 0) {
            hasFile = true;
        }
    });

    if (!hasFile) {
        showWarningModal(); // Show custom modal instead of alert()
        return false; // Prevent form submission
    }

    // If files are selected, show processing overlay
    showProcessingOverlay();
    return true; // Allow form submission
}

// Function to Show the Warning Modal
function showWarningModal() {
    document.getElementById("warning-modal").style.display = "flex";
}

// Function to Close the Warning Modal
function closeWarningModal() {
    document.getElementById("warning-modal").style.display = "none";
}

       // Show the processing overlay and start the progress adventure
function showProcessingOverlay() {
    const overlay = document.getElementById("processing-overlay");
    const progressFill = document.getElementById("progress-fill");
    const character = document.getElementById("progress-character");

    overlay.style.display = "flex";
    let progress = 0;

    const interval = setInterval(() => {
        progress += 10;
        progressFill.style.width = progress + "%";
        character.style.left = progress + "%";

        if (progress >= 100) {
            clearInterval(interval);
        }
    }, 400); // Adjust time per step as needed
}

// Hide the processing overlay
function hideProcessingOverlay() {
    const overlay = document.getElementById("processing-overlay");
    overlay.style.display = "none";
}

    </script>
<style>
    /* Centered Warning Modal */
    .modal {
        display: none; /* Hidden by default */
        position: fixed;
        z-index: 1000; /* Ensure it appears on top */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent background */
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* Modal Content */
    .modal-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
        width: 300px;
    }

    /* OK Button */
    .modal-content button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        margin-top: 10px;
        cursor: pointer;
        border-radius: 5px;
    }

    .modal-content button:hover {
        background-color: #0056b3;
    }
</style>
</head>
<body>
    <header>
        <h1>ProcessHub</h1>
    </header>

    <div id="stopwatch-container" style="display: none;">
    Processing Time: <span id="stopwatch">00:00:00:000</span>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flash-messages">
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <main>
         {% if download_link1 and download_link2 %}
          <script> stopStopwatch(); </script>
            <!-- GREPLEN Task: Display Two Download Links -->
            <h2>Replen Backorder Greece Task Completed Successfully</h2>
            <p>Your output files are ready:</p>
            <div class="button-container">
                <a href="{{ download_link1 }}" target="_blank" style="text-decoration: none; padding: 10px 20px; background-color: #28a745; color: white;    border-radius: 5px;">
                   Download OUTPUT3.csv
                </a>
                <a href="{{ download_link2 }}" target="_blank" style="text-decoration: none; padding: 10px 20px; background-color: #007bff; color: white; border-radius: 5px;">
                   Download OUTPUT2.csv
                </a>
                <a href="/" id="back-to-home" style="text-decoration: none; padding: 10px 20px; background-color: #f39c12; color: white; border-radius:  5px;">
                Back to Home
            </a>
            </div>

         {% elif download_link %}
            <script> stopStopwatch(); </script>
            <!-- For All Other Tasks: Display Single Download Link -->
            <h2>Task Completed Successfully</h2>
            <p>Your output file is ready:</p>

            <!-- Display Stopwatch Processing Time -->
            <div id="stopwatch-container">
                 Processing Completed in <span id="stopwatch"></span>
           </div>
            <div class="button-container">
                <a href="{{ download_link }}" target="_blank" style="text-decoration: none; padding: 10px 20px; background-color: #28a745; color: white; border-radius: 5px;">
                   Download {{ download_name }}
                </a>
                <a href="/" style="text-decoration: none; padding: 10px 20px; background-color: #007bff; color: white; border-radius: 5px;">
                    Back to Home
                </a>
            </div>
        {% else %}

            <!-- Display Task Selection Form -->
            <form id="task-form" method="post" enctype="multipart/form-data" action="#">
                <!-- Task Selection -->
                <div class="task-section">
                    <label for="task">Select a Task:</label>
                    <select name="task" id="task" onchange="toggleInputs()" required>
                        <option value="">-- Select a Task --</option>
                        <option value="bulk_report">Bulk Report</option>
                        <option value="replen_stock">Replen Stock</option>
                        <option value="check_empty_location">Check Empty Location</option>
                        <option value="target_performance">Target Performance Analysis</option>
                        <option value="replen_backorder_greece">Replen Backorder Greece</option>
                    </select>
                </div>

                <!-- Bulk Report Inputs -->
                <div id="bulk-report-inputs" class="task-inputs">
                    <label for="file-bulk-report">Select the BULK file:</label>
                    <input type="file" name="file" id="file-bulk-report" accept=".xlsx" required>
                    <p style="font-size: 0.9em; color: #555;">Upload the BULK.xlsx file containing the stock data for processing.</p>
                    <label for="aisle">Enter Aisle ID (e.g., A09) or leave blank for all aisles:</label>
                    <input type="text" name="aisle" id="aisle" placeholder="A09">
                </div>

                <!-- Replen Stock Inputs -->
                <div id="replen-stock-inputs" class="task-inputs">
                    <label for="file-replen">Upload Required Files for REPLEN Task:</label>
                    <input type="file" name="replen_files[]" id="file-replen" multiple accept=".xlsx" required>
                    <p class="file-instructions">Required files: BULK.xlsx, AS01011.xlsx, COVERAGE.xlsx, EXPORT.xlsx, 3PL.xlsx</p>
                </div>

                <!-- Check Empty Location Inputs -->
                <div id="check-empty-location-inputs" class="task-inputs">
                    <label for="file-check-empty">Upload the Latest BULK.xlsx:</label>
                    <input type="file" name="file" id="file-check-empty" accept=".xlsx" required>
                    <p style="font-size: 0.9em; color: #555;">Upload the latest BULK.xlsx file to identify empty locations.</p>
                </div>

               <!-- Target Performance Inputs -->
               <div id="target-performance-inputs" class="task-inputs">
                   <label for="file-targets">Upload SALES.csv and TARGET.csv:</label>
                   <input type="file" name="target_files[]" id="file-targets" accept=".csv" multiple required>
                   <p class="file-instructions">Upload both SALES.csv and TARGET.csv files for processing.</p>
               </div>

               <!-- Replen Backorder Greece Inputs -->
               <div id="replen-backorder-greece-inputs" class="task-inputs">
                   <label for="file-master">Upload MASTER.csv:</label>
                   <input type="file" name="replen_backorder_files[]" id="file-master" accept=".csv" required>
                   <p class="file-instructions">Upload the MASTER.csv file with required data.</p>

                   <label for="file-po">Upload PO.csv:</label>
                   <input type="file" name="replen_backorder_files[]" id="file-po" accept=".csv" required>
                   <p class="file-instructions">Upload the PO.csv file containing purchase order data.</p>
              </div>

                <!-- Submit Button -->
                <button type="submit" id="process-task-btn">Process Task</button>
            </form>
        {% endif %}
    </main>
    <footer>
        <p>&copy; 2025 ProcessHub. All rights reserved.</p>
    </footer>
<div id="processing-overlay" style="display: none;">
    <div class="overlay-content">
        <div class="adventure-container">
            <div id="progress-character" class="character"></div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
        </div>
        <p class="processing-quote"> Your request is being processed‚Äîjust moments away! üöÄ</p>
    </div>
</div>
<!-- Custom Warning Modal -->
<div id="warning-modal" class="modal">
    <div class="modal-content">
        <p>‚ö†Ô∏è Please select the required file(s) before processing.</p>
        <button onclick="closeWarningModal()">OK</button>
    </div>
</div>

<script>
// Stopwatch Variables
let stopwatchInterval;
let startTime;

// Function to Start Stopwatch
function startStopwatch() {
    clearInterval(stopwatchInterval); // Reset if already running
    startTime = performance.now();
    sessionStorage.setItem("stopwatchStart", startTime); // Save start time

    document.getElementById("stopwatch-container").style.display = "block"; // Show Stopwatch
    updateStopwatch();

    stopwatchInterval = setInterval(updateStopwatch, 10);
}

// Function to Update Stopwatch (Runs Every 10ms)
function updateStopwatch() {
    if (!startTime) return;

    let elapsedTime = performance.now() - startTime;
    let ms = Math.floor(elapsedTime % 1000);
    let seconds = Math.floor((elapsedTime / 1000) % 60);
    let minutes = Math.floor((elapsedTime / (1000 * 60)) % 60);
    let hours = Math.floor((elapsedTime / (1000 * 60 * 60)) % 24);

    let formattedTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}:${String(ms).padStart(3, '0')}`;
    document.getElementById("stopwatch").innerText = formattedTime;

    // Store Stopwatch Time to Persist Across Pages
    sessionStorage.setItem("stopwatchRunningTime", formattedTime);
}

// Function to Stop Stopwatch and Store Final Time
function stopStopwatch() {
    clearInterval(stopwatchInterval);

    let finalTime = document.getElementById("stopwatch").innerText;
    sessionStorage.setItem("finalStopwatchTime", finalTime); // Save final time

    document.getElementById("stopwatch-container").innerHTML =
        `Processing Completed in <span id="stopwatch">${finalTime}</span>`;
    document.getElementById("stopwatch-container").style.display = "block";
}

// Restore Stopwatch Time on Download Page
function restoreStopwatchTime() {
    let savedTime = sessionStorage.getItem("finalStopwatchTime");

    if (savedTime) {
        document.getElementById("stopwatch-container").innerHTML =
            `Processing Completed in <span id="stopwatch">${savedTime}</span>`;
        document.getElementById("stopwatch-container").style.display = "block";
    }
}

// Validate Form Before Submission
function validateForm() {
    // If the page has a download link, don't validate file selection
    if (document.getElementById("download-section")) {
        return true;
    }

    const task = document.getElementById("task")?.value;
    let fileInputs = document.querySelectorAll(".task-inputs:not([style*='display: none']) input[type='file']");
    let hasFile = false;

    fileInputs.forEach(input => {
        if (input.files.length > 0) {
            hasFile = true;
        }
    });

    // If required files are missing, show the warning modal and prevent submission
    if (!hasFile) {
        showWarningModal();
        return false; // Prevent form submission
    }

    startStopwatch(); // Start stopwatch when process begins
    showProcessingOverlay(); // Show processing overlay
    return true; // Allow form submission
}

// Ensure Stopwatch Appears on Download Page
document.addEventListener("DOMContentLoaded", function () {
    restoreStopwatchTime(); // Restore stopwatch time when page loads

    if (document.getElementById("download-section")) {
        stopStopwatch(); // Ensure Stopwatch Time is Displayed on Download Page
    }

    let processTaskBtn = document.getElementById("process-task-btn");
    if (processTaskBtn) {
        processTaskBtn.addEventListener("click", function (event) {
            if (!validateForm()) {
                event.preventDefault(); // Stop submission if files are missing
            }
        });
    }

    // Reset Stopwatch when Clicking "Back to Home"
    let backToHomeButton = document.getElementById("back-to-home");
    if (backToHomeButton) {
        backToHomeButton.addEventListener("click", function () {
            hideProcessingOverlay();
            closeWarningModal();
            sessionStorage.removeItem("finalStopwatchTime"); // Reset stopwatch
            sessionStorage.removeItem("stopwatchRunningTime"); // Clear Running Time
        });
    }

    // Hide warning modal on refresh or navigation back
    window.onload = function () {
        closeWarningModal();
    };

    window.addEventListener("pageshow", function () {
        closeWarningModal();
    });
});
</script>
</body>
</html>

